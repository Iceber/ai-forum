# 功能说明与用户使用链路

> 本文档说明 ai-forum 当前（第一阶段 / MVP）已支持的全部功能，以及用户的完整使用链路。

---

## 1. 当前已支持功能概览

### 1.1 功能矩阵

| 功能模块 | 功能点 | 状态 | 是否需要登录 |
|---------|--------|------|-------------|
| **身份认证** | 邮箱注册 | ✅ 已实现 | 否 |
| | 邮箱登录 | ✅ 已实现 | 否 |
| | 获取当前用户信息 | ✅ 已实现 | 是 |
| | 登出 | ✅ 已实现（前端清除 token） | 是 |
| **吧 (Bars)** | 浏览吧列表 | ✅ 已实现 | 否 |
| | 查看吧详情 | ✅ 已实现 | 否 |
| | 创建吧 | ❌ 未开放（暂无 API 对外提供） | 是 |
| **帖子 (Posts)** | 浏览帖子列表（全站/吧内） | ✅ 已实现 | 否 |
| | 查看帖子详情 | ✅ 已实现 | 否 |
| | 创建帖子 | ✅ 已实现 | 是 |
| **回复 (Replies)** | 浏览帖子回复 | ✅ 已实现 | 否 |
| | 发布回复（一级回复） | ✅ 已实现 | 是 |
| **浏览体验** | Cursor 分页加载更多 | ✅ 已实现 | 否 |
| | 首页吧推荐展示 | ✅ 已实现 | 否 |

### 1.2 当前未支持的功能（后续阶段）

| 功能 | 计划阶段 |
|------|---------|
| 二级回复（楼中楼） | 第二阶段 |
| 点赞 / 收藏 / 分享 | 第二阶段 |
| @用户提醒 | 第二阶段 |
| 消息通知中心 | 第二阶段 |
| 吧管理（编辑资料、吧务角色管理） | 第二阶段 |
| 加入/退出吧 | 第二阶段 |
| 个人中心（我的帖子/回复/收藏） | 第二阶段 |
| 全局搜索 | 第二阶段 |
| Markdown 内容渲染 | 第二阶段 |
| 媒体上传（图片/视频） | 第二阶段 |
| AI 重复帖检测 | v1 正式版 |
| AI 内容审核辅助 | v1 正式版 |
| AI 长帖摘要 | v1 正式版 |

---

## 2. 页面导航结构

```
┌───────────────────────────────────────────────────┐
│  Navbar（顶部导航栏，始终可见）                       │
│  [AI Forum Logo]    [发帖]    [登录] / [用户名 登出] │
└───────────────────────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
     ┌─────────┐   ┌──────────┐   ┌──────────────┐
     │  首页    │   │  登录页   │   │   注册页      │
     │  /      │   │  /login  │   │   /register  │
     └────┬────┘   └──────────┘   └──────────────┘
          │
    ┌─────┴──────┐
    ▼            ▼
┌────────┐  ┌──────────┐
│ 吧详情  │  │ 帖子详情  │
│/bars/id│  │/posts/id │
└────────┘  └──────────┘
                 │
                 ▼ (需登录)
          ┌──────────────┐
          │    发帖页     │
          │/create-post  │
          └──────────────┘
```

---

## 3. 用户使用链路

### 3.1 链路一：匿名浏览

> 无需登录即可完成全部浏览操作。

```
步骤 1: 打开首页 (/)
  └─ 看到最新帖子列表 + 推荐吧卡片
  └─ 可点击「加载更多」浏览更多帖子

步骤 2: 点击帖子标题
  └─ 进入帖子详情页 (/posts/:id)
  └─ 查看主楼内容 + 全部回复（按楼层排序）

步骤 3: 点击帖子所属吧名
  └─ 进入吧详情页 (/bars/:id)
  └─ 查看吧信息（名称、描述）
  └─ 浏览该吧下的帖子列表
```

**操作路径图**:
```
首页 ──点击帖子──▶ 帖子详情 ──点击吧名──▶ 吧详情
  │                                         │
  └──点击吧卡片──▶ 吧详情 ──点击帖子──▶ 帖子详情
```

---

### 3.2 链路二：注册新账号

```
步骤 1: 点击导航栏「注册」
  └─ 进入注册页 (/register)

步骤 2: 填写注册信息
  ├─ 邮箱（必填，合法邮箱格式）
  ├─ 密码（必填，8-128 字符）
  └─ 昵称（必填，2-50 字符）

步骤 3: 点击「注册」按钮
  └─ 调用 POST /api/auth/register
  └─ 成功后自动登录，保存 JWT Token
  └─ 自动跳转到首页
```

---

### 3.3 链路三：登录已有账号

```
步骤 1: 点击导航栏「登录」
  └─ 进入登录页 (/login)

步骤 2: 填写登录信息
  ├─ 邮箱（必填）
  └─ 密码（必填）

步骤 3: 点击「登录」按钮
  └─ 调用 POST /api/auth/login
  └─ 成功后保存 JWT Token 和用户信息到 localStorage
  └─ 自动跳转到首页
  └─ 导航栏显示用户昵称和「登出」按钮
```

---

### 3.4 链路四：发帖（需登录）

```
步骤 1: 登录后，点击导航栏「发帖」按钮
  └─ 进入发帖页 (/create-post)
  └─ 若未登录，需先跳转登录页

步骤 2: 填写发帖信息
  ├─ 选择吧（下拉选择，从 GET /api/bars 获取列表）
  ├─ 输入帖子标题（1-300 字符）
  └─ 输入帖子内容

步骤 3: 点击「发布」按钮
  └─ 调用 POST /api/posts（携带 Bearer Token）
  └─ 成功后自动跳转到新帖子的详情页
```

---

### 3.5 链路五：回复帖子（需登录）

```
步骤 1: 打开任意帖子详情页 (/posts/:id)
  └─ 查看主楼内容和现有回复

步骤 2: 在页面底部回复输入区填写内容

步骤 3: 点击「回复」按钮
  └─ 调用 POST /api/posts/:id/replies（携带 Bearer Token）
  └─ 成功后回复出现在回复列表中
  └─ 系统自动分配楼层号
  └─ 输入框清空，可继续回复
```

---

### 3.6 链路六：登出

```
步骤 1: 点击导航栏用户昵称旁的「登出」按钮
  └─ 清除 localStorage 中的 JWT Token 和用户信息
  └─ 页面跳转到首页
  └─ 导航栏恢复显示「登录」和「注册」按钮
```

---

## 4. 完整用户旅程示例

以下是一个新用户从注册到完成首次互动的完整旅程：

```
1. 用户首次访问首页 (/)
   └─ 浏览推荐吧和最新帖子

2. 点击一篇感兴趣的帖子
   └─ 阅读帖子内容和回复

3. 想要回复帖子，发现需要登录
   └─ 点击「注册」

4. 完成注册
   └─ 填写邮箱、密码、昵称 → 自动登录

5. 返回帖子详情页
   └─ 在回复区输入内容并提交
   └─ 回复成功，看到自己的回复出现在列表中

6. 想发一篇新帖
   └─ 点击导航栏「发帖」
   └─ 选择吧 → 填写标题和内容 → 发布
   └─ 跳转到新帖详情页

7. 继续浏览
   └─ 返回首页或进入其他吧继续浏览
```

---

## 5. 前端登录态管理机制

### 5.1 状态存储

- 使用 **Zustand** 管理登录状态
- `token` 和 `user` 对象持久化到 `localStorage`
- 页面刷新后自动从 `localStorage` 恢复登录态

### 5.2 请求认证

- `lib/api-client.ts` 中的 Axios 拦截器自动从 Store 读取 `token`
- 每个请求自动附加 `Authorization: Bearer <token>` 头

### 5.3 异常处理

- 当后端返回 **401 Unauthorized** 时：
  - 自动清除 Store 中的 token 和 user
  - 用户需重新登录

---

## 6. 数据加载策略

| 页面 | 首屏数据 | 增量加载 |
|------|---------|---------|
| 首页 | SSR 加载前 20 条帖子 + 12 个吧 | CSR 点击「加载更多」分页 |
| 吧详情 | CSR 加载吧信息 + 吧内帖子 | CSR 分页加载更多帖子 |
| 帖子详情 | CSR 加载帖子 + 前 50 条回复 | CSR 分页加载更多回复 |
| 登录/注册 | 无数据请求 | 表单提交后请求 API |
| 发帖 | CSR 加载吧列表 | 表单提交后请求 API |

> 注：吧详情和帖子详情页采用客户端渲染（CSR）以避免 Docker 环境下 SSR 跨容器请求的兼容性问题。

---

## 7. 快速体验指南

### 7.1 启动服务

```bash
# Docker 一键启动
docker-compose up -d

# 执行数据库迁移
cat backend/migrations/001_initial_schema.sql | \
  docker-compose exec -T postgres psql -U aiforum -d aiforum
```

### 7.2 创建测试数据

```bash
# 1. 注册种子用户
curl -s -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"Admin1234!","nickname":"管理员"}'

# 2. 获取用户 ID（从上一步返回的 JSON 中提取）

# 3. 创建测试 Bar（替换 <USER_ID>）
psql -h localhost -U aiforum -d aiforum -c "
INSERT INTO bars (name, description, created_by, created_at, updated_at)
VALUES
  ('技术讨论', '讨论编程、架构、技术趋势的地方', '<USER_ID>', NOW(), NOW()),
  ('闲聊水区', '轻松聊天，什么都可以聊', '<USER_ID>', NOW(), NOW());
"
```

### 7.3 访问地址

| 服务 | 地址 |
|------|------|
| 前端 | http://localhost:3000 |
| 后端 API | http://localhost:3001/api |

### 7.4 体验完整链路

1. 打开 http://localhost:3000 浏览首页
2. 点击「注册」创建账号
3. 进入某个吧，浏览帖子
4. 点击「发帖」发布一篇帖子
5. 进入帖子详情，发布回复
