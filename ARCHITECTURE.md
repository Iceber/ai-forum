# ARCHITECTURE

## 1. 目标与约束

基于 README 的产品目标，技术方案需要优先支持：
- 贴吧式高频浏览与快速发帖/回帖（低摩擦交互）
- 吧、帖子、楼层、角色权限、治理流程等核心社区模型
- v1 正式版可平滑接入 AI 辅助能力（重复帖检测、审核提示、长串摘要）
- 可扩展但不过度设计（当前阶段不引入消息队列与缓存系统）

---

## 2. 技术选型结论

### 2.1 前端框架

**选择：Next.js（React + TypeScript）**

原因：
- 组件生态成熟，适合社区类复杂页面（首页流、吧主页、帖子详情、消息页）
- 支持 SSR/SSG/CSR 混合渲染，兼顾首屏体验与交互效率
- TypeScript 可提升多人协作下的可维护性

---

### 2.2 后端语言

**选择：TypeScript（Node.js）**

原因：
- 与前端统一语言栈，降低协作和上下文切换成本
- 适合快速迭代社区产品（权限、内容、通知、审核流程）
- 对 AI 服务接入（HTTP API / SDK）友好

---

### 2.3 后端框架

**选择：NestJS**

原因：
- 模块化结构清晰，适合按领域拆分（Bars、Posts、Replies、Accounts、Moderation）
- 内置依赖注入、守卫、拦截器，便于实现角色权限与治理流程
- 社区生态完善，适合中长期演进

---

## 3. 数据库选型（是否支持多数据库）

### 3.1 主数据库

**选择：PostgreSQL（默认）**

原因：
- 关系模型能力强，适合社区核心实体与关系（用户、吧、帖子、楼层、角色、举报）
- 支持全文检索与 JSON 能力，便于后续扩展搜索和 AI 结构化结果存储
- 稳定性与生态成熟

### 3.2 多数据库策略

**结论：v1 以 PostgreSQL 单库落地，架构上保留多数据库兼容能力。**

建议策略：
- 数据访问层使用 ORM/Repository 抽象，避免业务代码直接绑定某一数据库方言
- 兼容目标优先考虑 MySQL（如部署环境强约束）
- 不在 v1 承诺“同一套生产环境同时运行多种数据库”，避免运维复杂度过高

---

## 4. 图片/视频存储方案

**选择：对象存储（S3 协议兼容）+ CDN**

方案说明：
- 图片与视频文件存储在对象存储（开发可用 MinIO，生产可用 AWS S3 / 阿里云 OSS / 腾讯云 COS）
- 业务数据库仅保存媒体元数据（URL、类型、大小、时长、上传者、关联帖子/回复）
- 上传采用预签名 URL 直传，降低后端带宽压力
- 对外访问通过 CDN 加速，提升帖内媒体加载体验

边界说明：
- 当前阶段不引入专门媒体处理流水线（如转码队列）；先支持基础上传与回显能力

---

## 5. 架构补充原则

- 先满足 MVP 核心社区闭环，再逐步增强 AI 能力
- AI 作为“辅助层”接入，不影响核心发帖/回帖主链路可用性
- 在不引入消息队列与缓存前提下，优先保证系统清晰性与可维护性
